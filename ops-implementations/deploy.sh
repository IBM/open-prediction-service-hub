#$!/bin/bash
SOURCE="${BASH_SOURCE[0]}"
DIR="$( dirname "$SOURCE" )"

DEPLOY_SERVICE=$1

DEPLOY_LATEST_TAG=latest
DEPLOY_TAG=$(date +'%Y%m%d-%H%M%S')-${TRAVIS_BUILD_NUMBER}-${TRAVIS_BRANCH//[\/]/-}

echo "DEPLOY_TAG=${DEPLOY_TAG}"

if [ "$TRAVIS_BRANCH" == "main" ]; then
    DEPLOY_LATEST_TAG=stable
fi
echo "DEPLOY_LATEST_TAG=${DEPLOY_LATEST_TAG}"

cd ${DIR}/${DEPLOY_SERVICE}
docker build -t ${DEPLOY_SERVICE}:${DEPLOY_LATEST_TAG} -f Dockerfile .
echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin "${DOCKER_REGISTRY_URL}"
docker tag ${DEPLOY_SERVICE}:${DEPLOY_LATEST_TAG} "${DOCKER_REGISTRY_URL}/${DOCKER_NAMESPACE}/${DEPLOY_SERVICE}:${DEPLOY_TAG}" 
docker tag ${DEPLOY_SERVICE}:${DEPLOY_LATEST_TAG} "${DOCKER_REGISTRY_URL}/${DOCKER_NAMESPACE}/${DEPLOY_SERVICE}:${DEPLOY_LATEST_TAG}" 
docker push "${DOCKER_REGISTRY_URL}/${DOCKER_NAMESPACE}/${DEPLOY_SERVICE}:${DEPLOY_TAG}"
docker push "${DOCKER_REGISTRY_URL}/${DOCKER_NAMESPACE}/${DEPLOY_SERVICE}:${DEPLOY_LATEST_TAG}"