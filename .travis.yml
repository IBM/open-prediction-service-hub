dist: bionic
language: python
python:
  - "3.7"

notifications:
  email: false

services:
  - docker

env:
  - MODEL_STORAGE=/tmp

before_install:
  - cd ml-service-implementations/ads-ml-service
  - python3 -m pip install --quiet --upgrade pip
  - python3 -m pip install --quiet -r requirements-test.txt
  - python3 -m pip install --quiet -r requirements-ml.txt
  - python3 -m pip install --quiet -r requirements.txt


script:
  - python3 -m pytest -v app/tests


before_deploy:
  - export DEPLOY_TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
  # example: demo:20190405-171003-4-master
  # '/' is replaces by -
  - docker build -t open-prediction:${DEPLOY_TIMESTAMP}-${TRAVIS_BUILD_NUMBER}-${TRAVIS_BRANCH//[\/]/-} -t open-prediction:latest -f Dockerfile .

# Needed to install IBM cloud cli
sudo: required

deploy:
  - provider: script
    skip_cleanup: true
    script: chmod +x kubernetes/* && kubernetes/ibm_image_registry.sh
    on:
      all_branches: true
      condition: env(RELEASE_YEAR) IS present AND \
                  env(RELEASE_QUARTER) IS present AND \
                  env(TRAVIS_BRANCH) == concat("release", "/", env(RELEASE_YEAR), env(RELEASE_QUARTER))
